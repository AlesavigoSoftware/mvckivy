#:kivy 2.3.0
#:import dp kivy.metrics.dp
#:import get_color_from_hex kivy.utils.get_color_from_hex

# Клиппер: скрывает всё, что выходит за его рамки (исправляет «мигание» при сворачивании)
<ClippedBox@StencilView+MDBoxLayout>:
    size_hint_y: None
#    height: self.minimum_height

<Handle@AnchorLayout>:
    anchor_x: "center"
    anchor_y: "center"
    size_hint_y: None
    height: dp(18)
    padding: 0, dp(8), 0, dp(6)
    Widget:
        size_hint: None, None
        size: dp(44), dp(4)
        canvas:
            Color:
                rgba: 1, 1, 1, .24
            RoundedRectangle:
                size: self.size
                pos: self.pos
                radius: [dp(2), dp(2), dp(2), dp(2)]

<Header@BoxLayout>:
    controller: None
    size_hint_y: None
    height: dp(60)
    padding: dp(16), dp(10)
    spacing: dp(12)
    md_bg_color: get_color_from_hex("#2B2D31")

    MDLabel:
        text: root.controller.title if root.controller else ""
        shorten: True
        shorten_from: "right"
        bold: True
        max_lines: 1
        valign: "middle"
        halign: "left"

    MDDropDownItem:
        id: transport_item
        on_release: root.controller.open_transport_menu(self) if root.controller else None
        pos_hint: {"center_y": .5}
        md_bg_color: "surfaceContainerColor"
        radius: dp(8)

        MDDropDownItemText:
            text: root.controller.transport if root.controller else ""
            role: "medium"
            theme_text_color: "Custom"
            text_color: app.theme_cls.onSurfaceColor

    MDBoxLayout:
        adaptive_size: True
        spacing: dp(8)

        MDIcon:
            icon: "wifi"
            theme_text_color: "Custom"
            text_color: 1, 1, 1, 1
            md_bg_color: get_color_from_hex("#22c55e")
            radius: dp(12)
            padding: dp(6)
            size_hint: None, None
            size: dp(24), dp(24)

        MDIcon:
            icon: "signal-cellular-3"
            theme_text_color: "Custom"
            text_color: 1, 1, 1, 1
            md_bg_color: get_color_from_hex("#3b82f6")
            radius: dp(12)
            padding: dp(6)
            size_hint: None, None
            size: dp(24), dp(24)

        MDIcon:
            icon: "battery-medium"
            theme_text_color: "Custom"
            text_color: 0.1, 0.1, 0.1, 1
            md_bg_color: get_color_from_hex("#eab308")
            radius: dp(12)
            padding: dp(6)
            size_hint: None, None
            size: dp(24), dp(24)

    MDIconButton:
        icon: "close"
        on_release: root.controller.collapse() if root.controller else None
        pos_hint: {"center_y": .5}

<CollapsibleMenuController>:
    MDCard:
        id: menu_card
        style: "filled"
        elevation: 2
        radius: dp(16)
        size_hint: None, None
        width: dp(560)
        height: root.ids.grip.height + root.ids.content_clip.height + root.ids.segbar.height
        pos: dp(16), dp(16)
        md_bg_color: get_color_from_hex("#1E1F23")
        orientation: "vertical"

        Handle:
            id: grip

        # Анимируемый контент в клиппере: ничего не «выпадает» при сворачивании
        ClippedBox:
            id: content_clip
            size_hint_y: None
            height: root.content_height
            opacity: 1 if root.content_height > 0 else 0
            orientation: "vertical"

            Header:
                id: hdr
                controller: root

            MDBoxLayout:
                padding: dp(12), dp(8), dp(12), dp(8)

                MDScrollView:
                    id: scroll
                    bar_width: dp(3)
                    do_scroll_x: False

                    MDBoxLayout:
                        id: sections
                        orientation: "vertical"
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(12)

                        MDLabel:
                            text: "Проектирование"
                            bold: True
                            theme_text_color: "Custom"
                            text_color: 1, 1, 1, .92
                            size_hint_y: None
                            height: self.texture_size[1] + dp(6)
                            padding: dp(6), dp(0)

                        MDDivider:
                            padding: dp(12)
                            color: 1, 1, 1, .08

                        GridLayout:
                            cols: root.cols
                            spacing: dp(8)
                            size_hint_y: None
                            height: self.minimum_height

                            MDListItem:
                                size_hint_y: None
                                height: dp(84)
                                radius: dp(12)
                                md_bg_color: get_color_from_hex("#24262B")
                                MDListItemLeadingIcon:
                                    icon: "pentagon-outline"
                                MDListItemHeadlineText:
                                    text: "Вставить фигуру"
                                MDListItemSupportingText:
                                    text: "Пентагон, круг, произвольный полигон"
                                MDListItemTrailingIcon:
                                    icon: "chevron-right"

                            MDListItem:
                                size_hint_y: None
                                height: dp(84)
                                radius: dp(12)
                                md_bg_color: get_color_from_hex("#24262B")
                                MDListItemLeadingIcon:
                                    icon: "pencil-outline"
                                MDListItemHeadlineText:
                                    text: "Редактировать"
                                MDListItemSupportingText:
                                    text: "Правка узлов и контуров"
                                MDListItemTrailingIcon:
                                    icon: "gesture"

                        MDLabel:
                            text: "Данные и сохранение"
                            bold: True
                            theme_text_color: "Custom"
                            text_color: 1, 1, 1, .92
                            size_hint_y: None
                            height: self.texture_size[1] + dp(6)
                            padding: dp(6), dp(0)

                        MDDivider:
                            padding: dp(12)
                            color: 1, 1, 1, .08

                        GridLayout:
                            cols: root.cols
                            spacing: dp(8)
                            size_hint_y: None
                            height: self.minimum_height

                            MDListItem:
                                size_hint_y: None
                                height: dp(84)
                                radius: dp(12)
                                md_bg_color: get_color_from_hex("#23262A")
                                MDListItemLeadingIcon:
                                    icon: "content-save-outline"
                                MDListItemHeadlineText:
                                    text: "Сохранить"
                                MDListItemSupportingText:
                                    text: "Локально на устройство"
                                MDListItemTrailingCheckbox:

                            MDListItem:
                                size_hint_y: None
                                height: dp(84)
                                radius: dp(12)
                                md_bg_color: get_color_from_hex("#23262A")
                                MDListItemLeadingIcon:
                                    icon: "cloud-upload-outline"
                                MDListItemHeadlineText:
                                    text: "Загрузить в облако"
                                MDListItemSupportingText:
                                    text: "Синхронизировать с сервером"
                                MDListItemTrailingIcon:
                                    icon: "cloud-outline"

                        MDLabel:
                            text: "Миссия"
                            bold: True
                            theme_text_color: "Custom"
                            text_color: 1, 1, 1, .92
                            size_hint_y: None
                            height: self.texture_size[1] + dp(6)
                            padding: dp(6), dp(0)

                        MDDivider:
                            padding: dp(12)
                            color: 1, 1, 1, .08

                        GridLayout:
                            cols: root.cols
                            spacing: dp(8)
                            size_hint_y: None
                            height: self.minimum_height

                            MDListItem:
                                size_hint_y: None
                                height: dp(84)
                                radius: dp(12)
                                md_bg_color: get_color_from_hex("#24262B")
                                MDListItemLeadingIcon:
                                    icon: "map-marker-outline"
                                MDListItemHeadlineText:
                                    text: "Выбрать полигон"
                                MDListItemSupportingText:
                                    text: "Коснитесь полигона на карте"
                                MDListItemTrailingIcon:
                                    icon: "crosshairs-gps"

                            MDListItem:
                                size_hint_y: None
                                height: dp(84)
                                radius: dp(12)
                                md_bg_color: get_color_from_hex("#24262B")
                                MDListItemLeadingIcon:
                                    icon: "cog-outline"
                                MDListItemHeadlineText:
                                    text: "Задать параметры"
                                MDListItemSupportingText:
                                    text: "Высота, скорость, перекрытие"
                                MDListItemTrailingIcon:
                                    icon: "tune-variant"

                            MDListItem:
                                size_hint_y: None
                                height: dp(84)
                                radius: dp(12)
                                md_bg_color: get_color_from_hex("#24262B")
                                MDListItemLeadingIcon:
                                    icon: "wand"
                                MDListItemHeadlineText:
                                    text: "Сгенерировать миссию"
                                MDListItemSupportingText:
                                    text: "Автоштриховка и маршрут"
                                MDListItemTrailingIcon:
                                    icon: "play"

                            MDListItem:
                                size_hint_y: None
                                height: dp(84)
                                radius: dp(12)
                                md_bg_color: get_color_from_hex("#24262B")
                                MDListItemLeadingIcon:
                                    icon: "send-variant-outline"
                                MDListItemHeadlineText:
                                    text: "Отправить на устройство"
                                MDListItemSupportingText:
                                    text: "Передача в автопилот"
                                MDListItemTrailingIcon:
                                    icon: "airplane"

                            MDListItem:
                                size_hint_y: None
                                height: dp(84)
                                radius: dp(12)
                                md_bg_color: get_color_from_hex("#24262B")
                                MDListItemLeadingIcon:
                                    icon: "help-circle-outline"
                                MDListItemHeadlineText:
                                    text: "О задании параметров"
                                MDListItemSupportingText:
                                    text: "Краткая справка"
                                MDListItemTrailingIcon:
                                    icon: "information-outline"

        # нижняя панель с сегментами — часть закрытого состояния
        MDCard:
            id: segbar
            elevation: 0
            md_bg_color: get_color_from_hex("#26272B")
            radius: [0, 0, dp(16), dp(16)]
            size_hint_y: None
            height: dp(56)
            padding: dp(12), dp(8)

            StretchSegmentedButton:
                id: seg_control
                fit_to_parent: True
                size_hint_x: 1
                size_hint_y: None
                height: dp(40)
                type: "normal"

                MDSegmentedButtonItem:
                    on_active: root.on_segment_pressed("map")
                    MDSegmentButtonIcon:
                        icon: "map-outline"
                    MDSegmentButtonLabel:
                        text: "Карта"

                MDSegmentedButtonItem:
                    on_active: root.on_segment_pressed("list")
                    MDSegmentButtonIcon:
                        icon: "format-list-bulleted"
                    MDSegmentButtonLabel:
                        text: "Список"

                MDSegmentedButtonItem:
                    on_active: root.on_segment_pressed("nav")
                    MDSegmentButtonIcon:
                        icon: "navigation-variant-outline"
                    MDSegmentButtonLabel:
                        text: "Навигация"

# корень
CollapsibleMenuController:
