#:import dp kivy.metrics.dp
#:import sp kivy.metrics.sp
#:import MDDivider kivymd.uix.divider.MDDivider
#:import MDLinearProgressIndicator kivymd.uix.progressindicator.MDLinearProgressIndicator

<TelemetryCard@MDCard>:
    base_w: 340
    base_h: 360
    scale: min(self.width / float(self.base_w), self.height / float(self.base_h))

    # MDCard tweaks per request
    style: "outlined"
    ripple_behavior: False
    focus_behavior: False
    theme_bg_color: "Custom"
    md_bg_color: app.theme_cls.surfaceColor

    orientation: "vertical"
    padding: dp(16) * root.scale
    spacing: dp(12) * root.scale
    radius: [16, 16, 16, 16]
    shadow_softness: 4
    shadow_offset: (0, -1)

    # HEADER
    MDBoxLayout:
        size_hint_y: None
        height: dp(40) * root.scale
        spacing: dp(8) * root.scale
        MDLabel:
            text: "Drone Telemetry"
            theme_text_color: "Primary"
            font_style: "Title"
            role: "large"
            theme_font_size: "Custom"
            font_size: sp(app.m3_size("Title","large") * root.scale)
            halign: "left"
            valign: "middle"
            size_hint_x: 1
            shorten: True
            shorten_from: "right"
        AnchorLayout:
            size_hint: None, None
            width: status_dot.width + dp(8) * root.scale + status_label.width
            height: dp(40) * root.scale
            anchor_x: "right"
            anchor_y: "center"
            MDBoxLayout:
                adaptive_size: True
                spacing: dp(8) * root.scale
                Widget:
                    id: status_dot
                    size_hint: None, None
                    size: dp(10) * root.scale, dp(10) * root.scale
                    pos_hint: {"center_y": .5}
                    md_bg_color: 0, .72, .24, 1
                    canvas.before:
                        Color:
                            rgba: self.md_bg_color
                        Ellipse:
                            pos: self.pos
                            size: self.size
                MDLabel:
                    id: status_label
                    text: "Active"
                    theme_text_color: "Hint"
                    font_style: "Body"
                    role: "medium"
                    theme_font_size: "Custom"
                    font_size: sp(app.m3_size("Body","medium") * root.scale)
                    adaptive_size: True
                    valign: "middle"

    MDDivider:
        color: app.theme_cls.outlineColor

    # BODY GRID
    MDGridLayout:
        cols: 2
        spacing: dp(12) * root.scale
        row_default_height: dp(56) * root.scale

        # Altitude
        MDBoxLayout:
            orientation: "vertical"
            MDLabel:
                text: "Altitude"
                theme_text_color: "Hint"
                font_style: "Label"
                role: "small"
                theme_font_size: "Custom"
                font_size: sp(app.m3_size("Label","small") * root.scale)
            MDBoxLayout:
                spacing: dp(4) * root.scale
                adaptive_height: True
                MDLabel:
                    id: alt_value
                    text: "10.9"
                    font_style: "Title"
                    role: "large"
                    theme_font_size: "Custom"
                    font_size: sp(app.m3_size("Title","large") * root.scale)
                    theme_text_color: "Custom"
                    text_color: (0.10, 0.45, 0.95, 1)
                    theme_font_name: "Custom"
                    font_name: "nasalization"
                    adaptive_size: True
                    size_hint_x: None
                MDLabel:
                    text: "m/s"
                    theme_text_color: "Custom"
                    text_color: (0.10, 0.45, 0.95, 1)
                    font_style: "Body"
                    role: "small"
                    theme_font_size: "Custom"
                    font_size: sp(app.m3_size("Body","small") * root.scale)
                    adaptive_size: True
                    size_hint_x: None

        # Speed
        MDBoxLayout:
            orientation: "vertical"
            MDLabel:
                text: "Speed"
                theme_text_color: "Hint"
                font_style: "Label"
                role: "small"
                theme_font_size: "Custom"
                font_size: sp(app.m3_size("Label","small") * root.scale)
            MDBoxLayout:
                spacing: dp(4) * root.scale
                adaptive_height: True
                MDLabel:
                    id: spd_value
                    text: "12.3"
                    font_style: "Title"
                    role: "large"
                    theme_font_size: "Custom"
                    font_size: sp(app.m3_size("Title","large") * root.scale)
                    theme_text_color: "Custom"
                    text_color: (0.0, 0.6, 0.3, 1)
                    theme_font_name: "Custom"
                    font_name: "nasalization"
                    adaptive_size: True
                    size_hint_x: None
                MDLabel:
                    text: "m/s"
                    theme_text_color: "Custom"
                    text_color: (0.0, 0.6, 0.3, 1)
                    font_style: "Body"
                    role: "small"
                    theme_font_size: "Custom"
                    font_size: sp(app.m3_size("Body","small") * root.scale)
                    adaptive_size: True
                    size_hint_x: None

        # Battery
        MDBoxLayout:
            orientation: "vertical"
            MDLabel:
                text: "Battery"
                theme_text_color: "Hint"
                font_style: "Label"
                role: "small"
                theme_font_size: "Custom"
                font_size: sp(app.m3_size("Label","small") * root.scale)
            MDBoxLayout:
                spacing: dp(4) * root.scale
                adaptive_height: True
                MDLinearProgressIndicator:
                    id: batt_bar
                    value: 68
                    type: "determinate"
                    size_hint_x: 1
                    size_hint_y: None
                    height: dp(10) * root.scale
                    indicator_color: 1, 0.72, 0, 1
                    track_color: 0.92, 0.92, 0.92, 1
                    radius: [6, 6, 6, 6]
                MDBoxLayout:
                    spacing: dp(8) * root.scale
                    adaptive_height: True
                    MDLabel:
                        id: batt_pct
                        text: "68%"
                        theme_text_color: "Hint"
                        font_style: "Body"
                        role: "small"
                        theme_font_size: "Custom"
                        font_size: sp(app.m3_size("Body","small") * root.scale)
                        theme_font_name: "Custom"
                        font_name: "nasalization"
                        adaptive_size: True
                        size_hint_x: None

        # Signal
        MDBoxLayout:
            orientation: "vertical"
            MDLabel:
                text: "Signal"
                theme_text_color: "Hint"
                font_style: "Label"
                role: "small"
                theme_font_size: "Custom"
                font_size: sp(app.m3_size("Label","small") * root.scale)
            MDBoxLayout:
                spacing: dp(4) * root.scale
                adaptive_height: True
                MDLinearProgressIndicator:
                    id: sig_bar
                    value: 92
                    type: "determinate"
                    size_hint_x: 1
                    size_hint_y: None
                    height: dp(10) * root.scale
                    indicator_color: 0.2, 0.45, 1, 1
                    track_color: 0.92, 0.92, 0.98, 1
                    radius: [6, 6, 6, 6]
                MDBoxLayout:
                    spacing: dp(8) * root.scale
                    adaptive_height: True
                    MDLabel:
                        id: sig_pct
                        text: "92%"
                        theme_text_color: "Hint"
                        font_style: "Body"
                        role: "small"
                        theme_font_size: "Custom"
                        font_size: sp(app.m3_size("Body","small") * root.scale)
                        theme_font_name: "Custom"
                        font_name: "nasalization"
                        adaptive_size: True
                        size_hint_x: None

        # Latitude
        MDBoxLayout:
            orientation: "vertical"
            MDLabel:
                text: "Latitude"
                theme_text_color: "Hint"
                font_style: "Label"
                role: "small"
                theme_font_size: "Custom"
                font_size: sp(app.m3_size("Label","small") * root.scale)
            MDLabel:
                id: lat_value
                text: "34.0522°"
                theme_text_color: "Custom"
                text_color: (0.55, 0.35, 0.9, 1)
                font_style: "Title"
                role: "medium"
                theme_font_size: "Custom"
                font_size: sp(app.m3_size("Title","medium") * root.scale)
                theme_font_name: "Custom"
                font_name: "nasalization"

        # Longitude
        MDBoxLayout:
            orientation: "vertical"
            MDLabel:
                text: "Longitude"
                theme_text_color: "Hint"
                font_style: "Label"
                role: "small"
                theme_font_size: "Custom"
                font_size: sp(app.m3_size("Label","small") * root.scale)
            MDLabel:
                id: lon_value
                text: "-118.2437°"
                theme_text_color: "Custom"
                text_color: (0.55, 0.35, 0.9, 1)
                font_style: "Title"
                role: "medium"
                theme_font_size: "Custom"
                font_size: sp(app.m3_size("Title","medium") * root.scale)
                theme_font_name: "Custom"
                font_name: "nasalization"

    MDDivider:
        color: app.theme_cls.outlineVariantColor

    # FOOTER
    MDBoxLayout:
        size_hint_y: None
        height: dp(60) * root.scale
        padding: 0, dp(6) * root.scale, 0, 0
        MDBoxLayout:
            orientation: "vertical"
            MDLabel:
                text: "Flight Mode"
                theme_text_color: "Hint"
                font_style: "Label"
                role: "small"
                theme_font_size: "Custom"
                font_size: sp(app.m3_size("Label","small") * root.scale)
            MDLabel:
                id: flight_value
                text: "122.0 m"
                theme_text_color: "Primary"
                font_style: "Title"
                role: "medium"
                theme_font_size: "Custom"
                font_size: sp(app.m3_size("Title","medium") * root.scale)
                theme_font_name: "Custom"
                font_name: "nasalization"
        Widget:
        MDButton:
            style: "filled"
            theme_width: "Custom"
            size_hint: None, None
            height: dp(36) * root.scale
            width: dp(108) * root.scale
            radius: [18 * root.scale, 18 * root.scale, 18 * root.scale, 18 * root.scale]
            on_release: app.on_change_pressed()
            md_bg_color: app.theme_cls.primaryColor

            MDButtonText:
                id: btn_text
                text: "Change"
                pos_hint: {"center_x": .5, "center_y": .5}
                theme_font_size: "Custom"
                font_size: sp(app.m3_size("Label","medium") * root.scale)

            MDButtonIcon:
                icon: "plus"
                opacity: 0
                size_hint_x: None
                width: 0
                x: btn_text.x - (self.width + dp(10) * root.scale)
